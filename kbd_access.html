<html>
<header>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <script src="./jslib/nipplejs.min.js"></script>
    <script src="./jslib/keyboarddongle.js"></script>
    <script src="./jslib/ui_init.js"></script>
    <title>KeyboardDongleControl</title>
    <style type="text/css">
        p {
            font-size: 12px;
            color: dimgray;
            text-align: center;
        }
        
        .center {
            text-align: center;
        }
        
        .mouseButton {
            position: absolute;
            display: block;
            background: red;
            opacity: .5;
            border-radius: 20px;
            color: white;
            text-align: center;
            vertical-align: middle;
            transition: opacity .1s ease-in-out;
        }
        
        .mouseBTNText {}
        
        .unselectable {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</header>

<body>
    <div style="display: none;">This is a page control BLE keyboard dongle, move cursor, type letters.</div>
    <div id="connectStatus" style="position: absolute; display: block; top: 2%; left: 2%;">
        <div id="connectStatusCircle" style="opacity: 0.8; background: red; border-radius: 50%; float: left;"></div>
        <div id="connectStatusText" class="unselectable" style="float: right; vertical-align: middle;">Not Connected</div>
    </div>
    <div id="switchKBD" class="unselectable" style="position: absolute; display: block; top: 2%; right: 2%; opacity: 0.8; background: yellow; color: grey; text-align: center; vertical-align: middle;">keyboard</div>
    <div id="mouse_joystick" class="center"></div>
    <div id="mouse_left" class="mouseButton unselectable">L</div>
    <div id="mouse_right" class="mouseButton unselectable">R</div>

    <script>
        var keyboardDongle = new KeyboardDongle();

        document.getElementById('connectStatus').addEventListener('click', event => {
            keyboardDongle.request()
                .then(_ => keyboardDongle.connect())
                .then(_ => {
                    document.getElementById('connectStatusText').innerHTML = "Connected to " + keyboardDongle.device.name;
                    document.getElementById('connectStatusCircle').style.backgroundColor = 'green';
                    //console.log("Connect OK")
                })
                .catch(error => {
                    console.log(error)
                });
        });

        var currentUI = 'mouse';
        document.getElementById('switchKBD').addEventListener('click', event => {
            if (currentUI == 'mouse') {
                switchMouseUI(false);
                currentUI='keyboard';
                document.getElementById('switchKBD').innerHTML='mouse';
            }else if (currentUI == 'keyboard') {
                switchMouseUI(true);
                currentUI='mouse';
                document.getElementById('switchKBD').innerHTML='keyboard';
            }
        });


        var timeStart = 0;

        var mouseTimerID = null;
        var mouseInProgress = false;
        var mouseData = [0, 0, 0, 0];

        function sendMouseReport() {
            clearInterval(mouseTimerID);
            if (mouseInProgress) {
                mouseTimerID = setInterval(sendMouseReport, 10);
            } else {
                mouseInProgress = true;
                timeStart = Date.now();
                keyboardDongle.writeMouseCharacter(new Uint8Array(mouseData))
                    .then(_ => {
                        mouseInProgress = false;
                        //console.log("Move OK");
                        console.log("delay:", Date.now() - timeStart);
                        var moveAgain = false;
                        for (var i = 1; i < 4; i++) {
                            if (mouseData[i] != 0) moveAgain = true;
                        }
                        if (moveAgain) {
                            clearInterval(mouseTimerID);
                            mouseTimerID = setInterval(sendMouseReport, 50);
                        }
                    })
                    .catch(error => {
                        mouseInProgress = false;
                        console.log(error)
                    });
            }
        }
    </script>


    <script>
        var mouseLeftButton = document.getElementById('mouse_left');
        var mouseRightButton = document.getElementById('mouse_right');
        var staticJoystick;


        function mouseButtonHandler(button, value) {
            if (mouseData[0] == 0 && value == 0) return;
            if (button == 0) {
                mouseLeftButton.style.opacity = (value != 0) ? '0.8' : '0.5';
                if ((value != 0)) {
                    mouseData[0] |= 1;
                } else {
                    mouseData[0] &= ~1;
                }
            } else if (button == 1) {
                mouseRightButton.style.opacity = (value != 0) ? '0.8' : '0.5';
                if ((value != 0)) {
                    mouseData[0] |= 2;
                } else {
                    mouseData[0] &= ~2;
                }
            }
            clearInterval(mouseTimerID);
            mouseTimerID = setInterval(sendMouseReport, 10);
        }

        uiInit();

        mouseLeftButton.addEventListener('mousedown', event => mouseButtonHandler(0, 1));
        mouseLeftButton.addEventListener('mouseup', event => mouseButtonHandler(0, 0));
        mouseLeftButton.addEventListener('mouseout', event => mouseButtonHandler(0, 0));
        mouseLeftButton.addEventListener('touchstart', event => mouseButtonHandler(0, 1));
        mouseLeftButton.addEventListener('touchend', event => mouseButtonHandler(0, 0));

        mouseRightButton.addEventListener('mousedown', event => mouseButtonHandler(1, 1));
        mouseRightButton.addEventListener('mouseup', event => mouseButtonHandler(1, 0));
        mouseRightButton.addEventListener('mouseout', event => mouseButtonHandler(1, 0));
        mouseRightButton.addEventListener('touchstart', event => mouseButtonHandler(1, 1));
        mouseRightButton.addEventListener('touchend', event => mouseButtonHandler(1, 0));

        staticJoystick.on('start end', function (evt, data) {
            if (evt.type == 'start') {
                //console.log('start');
            } else if (evt.type == 'end') {
                //console.log('end');
                mouseData[1] = 0;
                mouseData[2] = 0;
            }
            //console.log(evt);
        }).on('move', function (evt, data) {
            var x = data.force * Math.cos(data.angle.radian);
            var y = -data.force * Math.sin(data.angle.radian);
            //console.log(x,y);

            var intX = Math.round(x * 8);
            var intY = Math.round(y * 8);


            if (intX < 0) intX = 256 + intX;
            if (intY < 0) intY = 256 + intY;

            //console.log(intX, intY);

            if (mouseData[1] != intX || mouseData[2] != intY) {
                mouseData[1] = intX;
                mouseData[2] = intY;
                clearInterval(mouseTimerID);
                mouseTimerID = setInterval(sendMouseReport, 10);
            }

        })
    </script>



</body>

</html>