<html>
<header>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <script src="./jslib/nipplejs.min.js"></script>
    <script src="./jslib/keyboarddongle.js"></script>
    <title>KeyboardDongleControl</title>
    <style type="text/css">
        p {
            font-size: 12px;
            color: dimgray;
            text-align: center;
        }
        
        .center {
            text-align: center;
        }
        
        .mouseButton {
            position: absolute;
            display: block;
            background: red;
            opacity: .5;
            border-radius: 20px;
            color: white;
            text-align: center;
            vertical-align: middle;
            transition: opacity .1s ease-in-out;
        }
        
        .mouseBTNText {}
        
        .unselectable {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</header>

<body>
    <div id="connectStatus" style="position: absolute; display: block; top: 2%; left: 2%;">
        <div id="connectStatusCircle" style="opacity: 0.8; background: red; border-radius: 50%; float: left;"></div>
        <div id="connectStatusText" class="unselectable" style="float: right; vertical-align: middle;">Not Connected</div>
    </div>
    <div id="mouse_joystick" class="center"></div>
    <div id="mouse_left" class="mouseButton unselectable">L</div>
    <div id="mouse_right" class="mouseButton unselectable">R</div>
    <p>drag to xxx</p>

    <script>
        var keyboardDongle = new KeyboardDongle();

        document.getElementById('connectStatus').addEventListener('click', event => {
            keyboardDongle.request()
                .then(_ => keyboardDongle.connect())
                .then(_ => {
                    document.getElementById('connectStatusText').innerHTML = "Connected to " + keyboardDongle.device.name;
                    document.getElementById('connectStatusCircle').style.backgroundColor = 'green';
                    //console.log("Connect OK")
                })
                .catch(error => {
                    console.log(error)
                });
        });


        var timeStart = 0;

        /*document.getElementById('buttonTest').addEventListener('click', event => {
            clearInterval(mouseTimerID);
            mouseTimerID = setInterval(sendMouseReport, 0);
        });*/

        var mouseTimerID = null;
        var mouseInProgress = false;
        var mouseData = [0, 0, 0, 0];

        function sendMouseReport() {
            clearInterval(mouseTimerID);
            if (mouseInProgress) {
                mouseTimerID = setInterval(sendMouseReport, 10);
            } else {
                mouseInProgress = true;
                timeStart = Date.now();
                keyboardDongle.writeMouseCharacter(new Uint8Array(mouseData))
                    .then(_ => {
                        mouseInProgress = false;
                        //console.log("Move OK");
                        console.log("delay:", Date.now() - timeStart);
                        var moveAgain = false;
                        for (var i = 1; i < 4; i++) {
                            if (mouseData[i] != 0) moveAgain = true;
                        }
                        if (moveAgain) {
                            clearInterval(mouseTimerID);
                            mouseTimerID = setInterval(sendMouseReport, 50);
                        }
                    })
                    .catch(error => {
                        mouseInProgress = false;
                        console.log(error)
                    });
            }
        }
    </script>


    <script>
        var windowWidth, windowHeight; {
            var w = window
                , d = document
                , e = d.documentElement
                , g = d.getElementsByTagName('body')[0];
            windowWidth = w.innerWidth || e.clientWidth || g.clientWidth;
            windowHeight = w.innerHeight || e.clientHeight || g.clientHeight;

        }
        var dimensionLonger = Math.max(windowWidth, windowHeight);
        var dimensionShorter = Math.min(windowWidth, windowHeight);
        var dimensionLongerHalf = dimensionLonger / 2;
        console.log(windowWidth + ' Ã— ' + windowHeight);

        var connectStatusCircle = document.getElementById('connectStatusCircle');
        connectStatusCircle.style.width = connectStatusCircle.style.height = Math.round(dimensionShorter * .05) + 'px';
        document.getElementById('connectStatusText').style.lineHeight = connectStatusCircle.style.height;

        var mouseLeftButton = document.getElementById('mouse_left');
        var mouseRightButton = document.getElementById('mouse_right');
        var mouseButtonWidth = Math.round((windowWidth > windowHeight) ? (dimensionLongerHalf * .4) : (dimensionShorter * .4));
        var mouseButtonHeight = Math.round((windowWidth > windowHeight) ? (dimensionShorter * .4) : (dimensionLongerHalf * .8));
        mouseLeftButton.style.width = mouseRightButton.style.width = mouseButtonWidth.toString() + 'px';
        mouseLeftButton.style.height = mouseRightButton.style.height = mouseButtonHeight.toString() + 'px';
        mouseLeftButton.style.lineHeight = mouseRightButton.style.lineHeight = mouseButtonHeight.toString() + 'px';
        mouseLeftButton.style.fontSize = mouseRightButton.style.fontSize = mouseButtonHeight.toString() + 'px';

        if (windowWidth > windowHeight) {
            mouseLeftButton.style.left = '62.5%';
            mouseRightButton.style.left = '87.5%';
            mouseLeftButton.style.top = mouseRightButton.style.top = '50%';
            mouseLeftButton.style.marginTop = mouseRightButton.style.marginTop = '-' + (mouseButtonHeight / 2).toString() + 'px';
            mouseLeftButton.style.marginLeft = mouseRightButton.style.marginLeft = '-' + (mouseButtonWidth / 2).toString() + 'px';
        } else {
            mouseLeftButton.style.left = '25%';
            mouseRightButton.style.left = '75%';
            mouseLeftButton.style.top = mouseRightButton.style.top = '75%';
            mouseLeftButton.style.marginTop = mouseRightButton.style.marginTop = '-' + (mouseButtonHeight / 2).toString() + 'px';
            mouseLeftButton.style.marginLeft = mouseRightButton.style.marginLeft = '-' + (mouseButtonWidth / 2).toString() + 'px';
        }

        function mouseButtonHandler(button, value) {
            if (mouseData[0] == 0 && value == 0) return;
            if (button == 0) {
                mouseLeftButton.style.opacity = (value != 0) ? '0.8' : '0.5';
                if ((value != 0)) {
                    mouseData[0] |= 1;
                } else {
                    mouseData[0] &= ~1;
                }
            } else if (button == 1) {
                mouseRightButton.style.opacity = (value != 0) ? '0.8' : '0.5';
                if ((value != 0)) {
                    mouseData[0] |= 2;
                } else {
                    mouseData[0] &= ~2;
                }
            }
            clearInterval(mouseTimerID);
            mouseTimerID = setInterval(sendMouseReport, 10);
        }

        mouseLeftButton.addEventListener('mousedown', event => mouseButtonHandler(0, 1));
        mouseLeftButton.addEventListener('mouseup', event => mouseButtonHandler(0, 0));
        mouseLeftButton.addEventListener('mouseout', event => mouseButtonHandler(0, 0));
        mouseRightButton.addEventListener('mousedown', event => mouseButtonHandler(1, 1));
        mouseRightButton.addEventListener('mouseup', event => mouseButtonHandler(1, 0));
        mouseRightButton.addEventListener('mouseout', event => mouseButtonHandler(1, 0));

        var nippleJSoptions = {
            zone: document.getElementById('mouse_joystick')
            , mode: 'static'
            , position: {
                left: ((windowWidth > windowHeight) ? '25%' : '50%')
                , top: ((windowWidth <= windowHeight) ? '25%' : '50%')
            }
            , color: 'red'
            , size: Math.min(dimensionShorter, dimensionLongerHalf) * .8 //set to 25% screen width
        };

        var staticJoystick = nipplejs.create(nippleJSoptions);

        staticJoystick.on('start end', function (evt, data) {
            if (evt.type == 'start') {
                //console.log('start');
            } else if (evt.type == 'end') {
                //console.log('end');
                mouseData[1] = 0;
                mouseData[2] = 0;
            }
            //console.log(evt);
        }).on('move', function (evt, data) {
            var x = data.force * Math.cos(data.angle.radian);
            var y = -data.force * Math.sin(data.angle.radian);
            //console.log(x,y);

            var intX = Math.round(x * 4);
            var intY = Math.round(y * 4);


            if (intX < 0) intX = 256 + intX;
            if (intY < 0) intY = 256 + intY;

            //console.log(intX, intY);

            if (mouseData[1] != intX || mouseData[2] != intY) {
                mouseData[1] = intX;
                mouseData[2] = intY;
                clearInterval(mouseTimerID);
                mouseTimerID = setInterval(sendMouseReport, 10);
            }

        })
    </script>



</body>

</html>